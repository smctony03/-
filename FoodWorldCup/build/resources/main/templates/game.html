<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ìŒì‹ ì›”ë“œì»µ</title>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Jua', sans-serif; background-color: #121212; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; user-select: none; }
        h1 { color: #FFD700; margin-bottom: 10px; }
        .game-container { display: flex; gap: 40px; margin-top: 20px; }
        .card { width: 300px; height: 420px; background: #333; border: 3px solid #555; border-radius: 20px; cursor: pointer; transition: 0.2s; }
        .card:hover { transform: translateY(-10px); border-color: #FF6B6B; }
        .card img { width: 100%; height: 80%; object-fit: cover; border-bottom: 2px solid #555; }
        .card h2 { text-align: center; color: white; margin: 20px 0; }
        .info { color: #00d2d3; font-size: 1.2rem; }
    </style>
</head>
<body>

<h1 th:if="${mode == 'multi'}" th:text="'ğŸ“¢ ì°¸ê°€ì ' + ${currentPerson} + ' / ' + ${totalPeople} + ' ì°¨ë¡€'"></h1>
<h1 th:unless="${mode == 'multi'}">ğŸœ ì˜¤ëŠ˜ ë­ ë¨¹ì§€? ğŸ•</h1>

<div id="round-status" class="info">ê°• ì§„í–‰ ì¤‘</div>

<div class="game-container">
    <div class="card" onclick="choose(0)">
        <img id="img-left" src="">
        <h2 id="name-left">ìŒì‹1</h2>
    </div>
    <div class="card" onclick="choose(1)">
        <img id="img-right" src="">
        <h2 id="name-right">ìŒì‹2</h2>
    </div>
</div>

<form id="nextPersonForm" action="/next-person" method="post" style="display:none;">
    <input type="hidden" name="myFoods" th:value="${myFoodsRaw}">
    <input type="hidden" name="round" th:value="${roundRaw}">
    <input type="hidden" name="currentPerson" th:value="${currentPerson}">
    <input type="hidden" name="totalPeople" th:value="${totalPeople}">

    <input type="hidden" name="historyData" id="historyInput">
    <input type="hidden" name="accumulatedHistory" th:value="${accumulatedHistory}">
</form>

<script th:inline="javascript">
    let foods = [[${foods}]];
    let mode = [[${mode}]];
    // í˜„ì¬ ìˆœì„œì™€ ì´ ì¸ì›ìˆ˜ ê°€ì ¸ì˜¤ê¸°
    let currentPerson = [[${currentPerson}]];
    let totalPeople = [[${totalPeople}]];

    foods.sort(() => Math.random() - 0.5);

    let currentRoundFoods = foods;
    let nextRoundFoods = [];
    let currentIdx = 0;

    // ë‚´ê°€ ì„ íƒí•œ ëª¨ë“  ìŒì‹ì„ ì €ì¥í•  ë°°ì—´
    let mySelectionHistory = [];

    updateScreen();

    function updateScreen() {
        if (currentIdx >= currentRoundFoods.length) {
            currentRoundFoods = nextRoundFoods;
            nextRoundFoods = [];
            currentIdx = 0;

            // ìš°ìŠ¹ì ê²°ì • ì‹œì  (ê²Œì„ ì¢…ë£Œ)
            if (currentRoundFoods.length === 1) {
                let winnerName = currentRoundFoods[0].name;
                mySelectionHistory.push(winnerName); // ìš°ìŠ¹ìë„ ê¸°ë¡ì— ì¶”ê°€

                // 1. ê°™ì´ í•˜ê¸° ëª¨ë“œ
                if (mode === 'multi') {

                    if (currentPerson < totalPeople) {
                        // ì¤‘ê°„ ì‚¬ëŒì¸ ê²½ìš°ì—ë§Œ ì•Œë¦¼ì°½ ë„ì›€
                        alert("ğŸ‰ [" + winnerName + "] ì„ íƒ ì™„ë£Œ! ë‹¤ìŒ ì‚¬ëŒì—ê²Œ ë„˜ê¹ë‹ˆë‹¤.");
                    }
                    // ë§ˆì§€ë§‰ ì‚¬ëŒì€ ì•Œë¦¼ì°½ ì—†ì´ ë°”ë¡œ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™ (Form ì œì¶œ)

                    document.getElementById('historyInput').value = mySelectionHistory.join(",");
                    document.getElementById('nextPersonForm').submit();
                }
                // 2. í˜¼ì í•˜ê¸° ëª¨ë“œ
                else {
                    handleSoloWin(winnerName);
                }
                return;
            }
        }
        // í™”ë©´ ê°±ì‹ 
        document.getElementById("round-status").innerText = (currentRoundFoods.length === 2 ? "ğŸ‘‘ ê²°ìŠ¹ì „ ğŸ‘‘" : currentRoundFoods.length + "ê°•");
        document.getElementById("img-left").src = currentRoundFoods[currentIdx].imgUrl;
        document.getElementById("name-left").innerText = currentRoundFoods[currentIdx].name;
        document.getElementById("img-right").src = currentRoundFoods[currentIdx+1].imgUrl;
        document.getElementById("name-right").innerText = currentRoundFoods[currentIdx+1].name;
    }

    function choose(idx) {
        // í´ë¦­í•  ë•Œë§ˆë‹¤ ì„ íƒí•œ ìŒì‹ì„ ê¸°ë¡
        let pickedFood = currentRoundFoods[currentIdx + idx];
        mySelectionHistory.push(pickedFood.name);

        nextRoundFoods.push(pickedFood);
        currentIdx += 2;
        updateScreen();
    }

    function handleSoloWin(winnerName) {
        let firstWinner = localStorage.getItem("firstWinner");
        if (!firstWinner) {
            alert("1ì°¨ì „ ìš°ìŠ¹: [" + winnerName + "]");
            localStorage.setItem("firstWinner", winnerName);
            localStorage.setItem("foodHistory", mySelectionHistory.join(","));
            location.reload();
        } else {
            let fullHistory = localStorage.getItem("foodHistory") + "," + mySelectionHistory.join(",");
            localStorage.removeItem("firstWinner");
            localStorage.removeItem("foodHistory");
            location.href = "/result?winner1=" + encodeURIComponent(firstWinner)
                + "&winner2=" + encodeURIComponent(winnerName)
                + "&history=" + encodeURIComponent(fullHistory);
        }
    }
</script>
</body>
</html>